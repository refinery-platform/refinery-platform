sudo: required

language: python
cache:
  - pip
  - directories:
      - geckodriver
      - refinery/ui/node_modules
      - refinery/ui/bower_components
addons:
  firefox: "53.0.3"
  apt:
    packages:
      - xvfb

python:
  - 2.7

services:
  - postgresql

matrix:
  include:
    - env: GRUNT_TESTS=True
    - env: DJANGO_SELENIUM_TESTS=True
    - env: DJANGO_UNIT_TESTS=True

install:
  - |
    if ! [ "$DJANGO_UNIT_TESTS" ]; then
      node --version
      NODE_VERSION=6.11.0
      nvm install $NODE_VERSION
      nvm use $NODE_VERSION
      node --version
      npm --version
      npm install -g npm@3.10.10
      npm --version
    fi
  - if ! [ "$GRUNT_TESTS" ]; then pip install -r requirements.txt --quiet; fi

  # Install geckodriver required for selenium testing
  - |
    if [ "$DJANGO_SELENIUM_TESTS" ]; then
      GECKODRIVER_VERSION=v0.17.0
      TAR=geckodriver-$GECKODRIVER_VERSION-linux64.tar
      wget https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/$TAR.gz
      gunzip $TAR.gz
      tar -xvf $TAR
      chmod a+x geckodriver
      export PATH=$PATH:`pwd`
    fi

env:
  global:
    # These env vars are available to every build
    - PYTHONPATH=$PYTHONPATH:../refinery:../refinery/config
    - DJANGO_SETTINGS_MODULE=config.settings.prod

before_script:
  - |
    if ! [ "$GRUNT_TESTS" ]; then
      # Vagrant is not used on travis: This user is just for the database.
      createuser --createdb --no-superuser --no-createrole vagrant
      createdb -O vagrant refinery
      sudo mkdir /data
      sudo chown $USER /data
      pushd refinery
      # See http://www.stuartellis.eu/articles/erb/#running-erb-from-the-command-line
      erb config/config.json.erb > config/config.json
      python manage.py migrate --noinput
      popd
    fi
  - |
    if ! [ "$DJANGO_UNIT_TESTS" ]; then
      pushd refinery
      npm install -g grunt-cli@0.1.13 bower@1.7.7 --progress false --quiet || ( cat npm-debug.log && false )
      pushd ui
      npm install --progress false --quiet || ( cat npm-debug.log && false )
      bower install --config.interactive=false --quiet
      popd && popd
    fi

script:
  - set -e # Any error will cause travis to exit early and report a failure.
  - |
    if ! [ "$GRUNT_TESTS" ]; then
      # TODO: Not the same behavior as pre-commit hook.
      # https://github.com/refinery-platform/refinery-platform/issues/1851
      flake8 --exclude=migrations,ui ..
    fi

  - pushd refinery
  - echo 'travis_fold:start:grunt'
  - pushd ui
  - if ! [ "$DJANGO_UNIT_TESTS" ]; then grunt make; fi
  - if [ "$GRUNT_TESTS" ]; then grunt test; fi
  - popd && popd
  - echo 'travis_fold:end:grunt'

  - |
    if [ "$DJANGO_UNIT_TESTS" ]; then
      echo 'travis_fold:start:django-unit-tests'
      coverage run manage.py test
      echo 'travis_fold:end:django-unit-tests'
    fi

  - |
    if [ "$DJANGO_SELENIUM_TESTS" ]; then
      echo 'travis_fold:start:django-selenium-tests'
      coverage run manage.py test --pattern="selenium_tests.py"
      echo 'travis_fold:end:django-selenium-tests'
    fi

  - set +e # Currently, codecov does not always exit with 0, but that should not cause travis to fail.

after_success:
  - echo 'travis_fold:start:codecov'
  - if ! [ "$GRUNT_TESTS" ]; then codecov; fi
  - if [ "$GRUNT_TESTS"]; then npm run codecov; fi
  - echo 'travis_fold:end:codecov'

notifications:
  slack:
    secure: nDs9Oj08nRizuD0edl6WcrSgaTPMyITQjZc4qPZpt+yOxUehWbrAmVhqYypfyvdj4qSi1E72rPTXftuBB1E1IZBgX4CCkrCkWGLgIxHaaValTd64oOX66eC3BbSehQxuJB7w1DWw54xBUkTy6+ufjAqiwhLpoEUeE296urAWYHU=
