sudo: required

language: python
cache:
  - pip
  - directories:
      - geckodriver
      - refinery/ui/node_modules
      - refinery/ui/bower_components
addons:
  firefox: "53.0.3"
  apt:
    packages:
      - xvfb

python:
  - 2.7

services:
  - postgresql

env:
  global:
    # These env vars are available to every build
    - PYTHONPATH=$PYTHONPATH:../refinery:../refinery/config
    - CODECOV=codecov
    - DJANGO_SETTINGS_MODULE=config.settings.prod
    - FLAKE8=flake8
    - GRUNT=grunt

matrix:
  include:
    - env: TEST_SUITE='coverage run manage.py test'
    - if: type = pull_request
      env: TEST_SUITE='coverage run manage.py test --pattern="selenium_tests.py"'

install:
  - start() { echo travis_fold':'start:$1; echo $1; }
  - end() { echo travis_fold':'end:$1; }

  - node --version
  - NODE_VERSION=6.11.0
  - nvm install $NODE_VERSION
  - nvm use $NODE_VERSION
  - node --version
  - npm --version
  - npm install -g npm@3.10.10
  - npm --version

  - pip install -r requirements.txt --quiet

  # Install geckodriver required for selenium testing
  - GECKODRIVER_VERSION=v0.17.0
  - TAR=geckodriver-$GECKODRIVER_VERSION-linux64.tar
  - wget https://github.com/mozilla/geckodriver/releases/download/$GECKODRIVER_VERSION/$TAR.gz
  - gunzip $TAR.gz
  - tar -xvf $TAR
  - chmod a+x geckodriver
  - export PATH=$PATH:`pwd`

before_script:
  # Vagrant is not used on travis: This user is just for the database.
  - createuser --createdb --no-superuser --no-createrole vagrant
  - createdb -O vagrant refinery
  - sudo mkdir /data
  - sudo chown $USER /data
  - pushd refinery
  # See http://www.stuartellis.eu/articles/erb/#running-erb-from-the-command-line
  - erb config/config.json.erb > config/config.json
  - python manage.py migrate --noinput

  - npm install -g grunt-cli@0.1.13 bower@1.7.7 --progress false --quiet || (cat npm-debug.log && false )
  - pushd ui
  - npm install --progress false --quiet || ( cat npm-debug.log && false )
  - bower install --config.interactive=false --quiet
  - popd && popd


script:
  - set -e # Any error will cause travis to exit early and report a failure.
  - start $FLAKE8
  # TODO: Not the same behavior as pre-commit hook.
  # https://github.com/refinery-platform/refinery-platform/issues/1851
  - flake8 --exclude=migrations,ui ..
  - end $FLAKE8

  - start $GRUNT
  - pushd refinery
  - pushd ui && grunt && popd
  - end $GRUNT

  - start $TEST_SUITE
  - $TEST_SUITE
  - end $TEST_SUITE
  - set +e # Currently, codecov does not always exit with 0, but that should not cause travis to fail.

after_success:
  - start $CODECOV
  - codecov
  - npm run codecov
  - end $CODECOV

notifications:
  slack:
    secure: nDs9Oj08nRizuD0edl6WcrSgaTPMyITQjZc4qPZpt+yOxUehWbrAmVhqYypfyvdj4qSi1E72rPTXftuBB1E1IZBgX4CCkrCkWGLgIxHaaValTd64oOX66eC3BbSehQxuJB7w1DWw54xBUkTy6+ufjAqiwhLpoEUeE296urAWYHU=
